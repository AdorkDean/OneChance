var txIndex = 0;
// 部署合约,使用的同步挖矿脚本等到合约部署成功拿到合约地址后才部署下一个依赖合约,因此不需要再回掉方法中做业务逻辑
// 实际情况中可能要等前一个合约的回调函数触发拿到合约地址才能继续部署下一个合约

// 部署地址转换合约
personal.unlockAccount(eth.accounts[0], "test123456");
var addresscompressContract = web3.eth.contract([{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"uidOf","outputs":[{"name":"","type":"uint32"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint32"}],"name":"addrOf","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"topUid","outputs":[{"name":"","type":"uint32"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"regist","outputs":[{"name":"uid","type":"uint32"}],"payable":false,"type":"function"}]);
var addresscompress = addresscompressContract.new(
   {
     from: web3.eth.accounts[0], 
     data: '6060604052610169806100126000396000f3606060405260e060020a60003504630b688f40811461003f5780631d0cce4c14610062578063db13970514610095578063ff776f55146100a9575b610002565b34610002576100eb60043560006020819052908152604090205463ffffffff1681565b346100025761010560043560016020526000908152604090205473ffffffffffffffffffffffffffffffffffffffff1681565b34610002576100eb60025463ffffffff1681565b34610002576100eb60043573ffffffffffffffffffffffffffffffffffffffff811660009081526020819052604081205463ffffffff16811461010f57610002565b6040805163ffffffff929092168252519081900360200190f35b6060908152602090f35b60408082206002805463ffffffff1980821663ffffffff928316600190810191821790945584549091168117909355821684526020529120805473ffffffffffffffffffffffffffffffffffffffff19168317905591905056', 
     gas: 4700000
   }, function (e, contract){
    console.log(e, contract);
    if (typeof contract.address !== 'undefined') {
         console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
    }
 });
miner.start(1); admin.sleepBlocks(1); miner.stop();

// 部署代币合约
personal.unlockAccount(eth.accounts[0], "test123456");
var _name = "ChanceCoin" ;
var _symbol = "C" ;
var _decimals = 0 ;
var _addressCompress = addresscompress.address;
var onechancecoinContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_oneChance","type":"address"}],"name":"initOneChance","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_consumerUid","type":"uint32"},{"name":"_value","type":"uint32"}],"name":"consume","outputs":[{"name":"success","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"addressCompress","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"sponsor","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_receiver","type":"address"},{"name":"_value","type":"uint32"}],"name":"transfer","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"oneChance","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_receiver","type":"address"},{"name":"_value","type":"uint32"},{"name":"_txIndex","type":"uint256"}],"name":"mint","outputs":[],"payable":false,"type":"function"},{"inputs":[{"name":"_name","type":"string"},{"name":"_symbol","type":"string"},{"name":"_decimals","type":"uint8"},{"name":"_addressCompress","type":"address"}],"type":"constructor"},{"anonymous":false,"inputs":[],"name":"InitOneChance","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"receiver","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"receiver","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"txIndex","type":"uint256"}],"name":"Mint","type":"event"}]);
var onechancecoin = onechancecoinContract.new(
   _name,
   _symbol,
   _decimals,
   _addressCompress,
   {
     from: web3.eth.accounts[0], 
     data: '6060604052604051610a18380380610a1883398101604052805160805160a05160c05192840193919091019133600260016101000a815481600160a060020a03021916908302179055508360006000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100e257805160ff19168380011785555b506101129291505b8082111561016b576000815560010161009c565b50506002805460ff19168317905560048054600160a060020a03191682179055505050506108798061019f6000396000f35b82800160010185558215610094579182015b828111156100945782518260005055916020019190600101906100f4565b50508260016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061016f57805160ff19168380011785555b506100b092915061009c565b5090565b8280016001018555821561015f579182015b8281111561015f578251826000505591602001919060010190610181566060604052361561008d5760e060020a600035046303bcebea811461009257806306fdde03146100be5780630aa83f5a14610121578063313ce5671461014e5780635d1388ce1461015f57806370a082311461017657806377c9366214610210578063800974841461022c57806383873666146102be57806395d89b41146102d5578063ca3181e014610337575b610002565b346100025761036b6004356002546101009004600160a060020a03908116339091161461043457610002565b34610002576040805160008054602060026001831615610100026000190190921691909104601f810182900482028401820190945283835261036d93908301828280156104c25780601f10610497576101008083540402835291602001916104c2565b34610002576103db600435602435600354600090600160a060020a0390811633909116146104ca57610002565b34610002576103ef60025460ff1681565b3461000257610405600454600160a060020a031681565b3461000257610422600435600060056000506000600460009054906101000a9004600160a060020a0316600160a060020a0316630b688f40856040518260e060020a0281526004018082600160a060020a03168152602001915050602060405180830381600087803b156100025760325a03f115610002575050604080515163ffffffff9081169093526020939093525091205416919050565b34610002576104056002546101009004600160a060020a031681565b346100025761036b60043560243560006000600460009054906101000a9004600160a060020a0316600160a060020a0316630b688f40336040518260e060020a0281526004018082600160a060020a03168152602001915050602060405180830381600087803b156100025760325a03f1156100025750506040515192505063ffffffff821681141561052657610002565b3461000257610405600354600160a060020a031681565b346100025760408051600180546020600282841615610100026000190190921691909104601f810182900482028401820190945283835261036d93908301828280156104c25780601f10610497576101008083540402835291602001916104c2565b346100025761036b60043560243560443560025460009033600160a060020a0390811661010090920416146106f257610002565b005b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156103cd5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b604080519115158252519081900360200190f35b6040805160ff9092168252519081900360200190f35b60408051600160a060020a03929092168252519081900360200190f35b60408051918252519081900360200190f35b600354600160a060020a031660001461044c57610002565b6003805473ffffffffffffffffffffffffffffffffffffffff1916821790556040517ffc61118d9baf11f37d3039c67ee749387b3655da0c80a6074b0a7364d65284a890600090a150565b820191906000526020600020905b8154815290600101906020018083116104a557829003601f168201915b505050505081565b63ffffffff838116600090815260056020526040902054838216911610156104f157610002565b5063ffffffff918216600090815260056020526040902080549283169190910363ffffffff1992909216919091179055600190565b63ffffffff8281166000908152600560205260409020548482169116101561054d57610002565b600460009054906101000a9004600160a060020a0316600160a060020a0316630b688f40856040518260e060020a0281526004018082600160a060020a03168152602001915050602060405180830381600087803b156100025760325a03f1156100025750506040515191505063ffffffff81166000141561063757600460009054906101000a9004600160a060020a0316600160a060020a031663ff776f55856040518260e060020a0281526004018082600160a060020a03168152602001915050602060405180830381600087803b156100025760325a03f115610002575050604051519150505b63ffffffff8181166000908152600560205260409020548116808501909116101561066157610002565b63ffffffff8281166000908152600560209081526040808320805480861689900363ffffffff199182161790915585851684529281902080548086168901941693909317909255815192861683529051600160a060020a03878116933391909116927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef92918290030190a350505050565b600460009054906101000a9004600160a060020a0316600160a060020a0316630b688f40856040518260e060020a0281526004018082600160a060020a03168152602001915050602060405180830381600087803b156100025760325a03f1156100025750506040515191505063ffffffff8116600014156107dc57600460009054906101000a9004600160a060020a0316600160a060020a031663ff776f55856040518260e060020a0281526004018082600160a060020a03168152602001915050602060405180830381600087803b156100025760325a03f115610002575050604051519150505b63ffffffff8181166000908152600560205260409020548116848101909116101561080657610002565b6040600081812063ffffffff84811690925260056020908152815463ffffffff1981169084168801179091558251918616825281018490528151600160a060020a038716927f4c209b5fc8ad50758f13e2e1088ba56a560dff690a1c6fef26394f4c03821c4f928290030190a25050505056', 
     gas: 4700000
   }, function (e, contract){
    console.log(e, contract);
    if (typeof contract.address !== 'undefined') {
         console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
    }
 });
miner.start(1); admin.sleepBlocks(1); miner.stop();

// 部署 OneChance 合约
personal.unlockAccount(eth.accounts[0], "test123456");
var _oneChanceCoin = onechancecoin.address;
var onechanceContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_goodsId","type":"uint32"},{"name":"_quantity","type":"uint32"},{"name":"_ciphertext","type":"bytes32"},{"name":"_txIndex","type":"uint256"}],"name":"buyChance","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"oneChanceCoin","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_goodsId","type":"uint32"},{"name":"_userId","type":"uint32"},{"name":"_plaintext","type":"uint256"},{"name":"_txIndex","type":"uint256"}],"name":"submitPlaintext","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_goodsId","type":"uint32"}],"name":"goods","outputs":[{"name":"name","type":"string"},{"name":"amt","type":"uint32"},{"name":"description","type":"string"},{"name":"consumersLength","type":"uint256"},{"name":"ciphertextsLength","type":"uint32"},{"name":"plaintextsLength","type":"uint32"},{"name":"winnerId","type":"uint32"},{"name":"winnerAddr","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"addressCompress","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_name","type":"string"},{"name":"_amt","type":"uint32"},{"name":"_description","type":"string"},{"name":"_txIndex","type":"uint256"}],"name":"postGoods","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"sponsor","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_goodsId","type":"uint32"},{"name":"_userId","type":"uint32"}],"name":"user","outputs":[{"name":"userAddr","type":"address"},{"name":"ciphertext","type":"bytes32"},{"name":"plaintext","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"topGoodsId","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"inputs":[{"name":"_oneChanceCoin","type":"address"},{"name":"_addressCompress","type":"address"}],"type":"constructor"},{"anonymous":false,"inputs":[],"name":"InitOneChanceCoin","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"goodsId","type":"uint256"},{"indexed":false,"name":"txIndex","type":"uint256"}],"name":"PostGoods","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"consumer","type":"address"},{"indexed":false,"name":"beginUserId","type":"uint256"},{"indexed":false,"name":"txIndex","type":"uint256"}],"name":"BuyChance","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"goodsId","type":"uint256"}],"name":"NotifySubmitPlaintext","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"consumer","type":"address"},{"indexed":false,"name":"txIndex","type":"uint256"}],"name":"SubmitPlaintext","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"goodsId","type":"uint256"},{"indexed":false,"name":"winner","type":"uint256"}],"name":"NotifyWinnerResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"out","type":"string"}],"name":"Print","type":"event"}]);
var onechance = onechanceContract.new(
   _oneChanceCoin,
   _addressCompress,
   {
     from: web3.eth.accounts[0], 
     data: '6060604081815280611154833960a090525160805160008054600160a060020a0319908116331790915560018054821684179055600280549091168217905550506111068061004e6000396000f3606060405236156100775760e060020a600035046315b8003b811461007c578063356db637146101195780635302470a14610130578063578551aa146101ab5780635d1388ce1461028957806369d1d1ca146102a057806377c93662146103a25780637b17e543146103b9578063d45a717e146104c9575b610002565b34610002576104e360043560243560443560643560006000604060405190810160405280600081526020016000815260200150600060036000506001890363ffffffff168154811015610002579082526006027fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b0181506001810154600482015491955063ffffffff908116908916909101111561064357610002565b34610002576104e5600154600160a060020a031681565b34610002576104e3600435602435604435606435600060006000600060036000506001890363ffffffff168154811015610002579082526006027fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b0181506001810154600482015491955063ffffffff161461095257610002565b3461000257610502600435602060405190810160405280600081526020015060006020604051908101604052806000815260200150600060006000600060006000600360005060018b0363ffffffff1681548110156100025791526040805160069092027fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b018054602060026001831615610100026000190190921691909104601f81018290048202850182019093528284529092918391830182828015610b9d5780601f10610b7257610100808354040283529160200191610b9d565b34610002576104e5600254600160a060020a031681565b34610002576104e36004808035906020019082018035906020019191908080601f0160208091040260200160405190810160405280939291908181526020018383808284375050604080516020604435808b0135601f81018390048302840183019094528383529799893599909860649850929650919091019350909150819084018382808284375094965050933593505050506040805161010081018252600060e08201818152825260208281018290528351808201855282815283850152606083018290526080830182905260a08301829052835190810190935280835260c0820192909252905433600160a060020a03908116911614610d2257610002565b34610002576104e5600054600160a060020a031681565b346100025761061a6004356024356000600060006000600060036000506001880363ffffffff16815481101561000257906000526020600020906006020160005060025460048201805492945060001989019350600160a060020a0390911691631d0cce4c919063ffffffff8516908110156100025790600052602060002090600891828204019190066004029054906101000a900463ffffffff166040518260e060020a028152600401808263ffffffff168152602001915050602060405180830381600087803b156100025760325a03f115610002575050604080515163ffffffff841660009081526005860160205291909120805460019190910154919750955093505050509250925092565b346100025760035460408051918252519081900360200190f35b005b60408051600160a060020a03929092168252519081900360200190f35b60405180806020018963ffffffff168152602001806020018881526020018763ffffffff1681526020018663ffffffff1681526020018563ffffffff16815260200184600160a060020a0316815260200183810383528b8181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156105ab5780820380516001836020036101000a031916815260200191505b508381038252898181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156106045780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390f35b60408051600160a060020a03949094168452602084019290925282820152519081900360600190f35b6040805160008152905190819003600101902086141561066257610002565b604080516002547f0b688f4000000000000000000000000000000000000000000000000000000000825233600160a060020a0390811660048401529251921691630b688f40916024818101926020929091908290030181600087803b156100025760325a03f1156100025750506040805180516001547f0aa83f5a00000000000000000000000000000000000000000000000000000000835263ffffffff82811660048501528c1660248401529251909650600160a060020a03929092169250630aa83f5a9160448281019260209291908290030181600087803b156100025760325a03f115610002575050604080516004870154600101815260208101889052815133600160a060020a031693507fea878a7921291dab7a183f4734c66b4d6b59688be30cf3b3378b860ab739d4d0929181900390910190a28582600001906000191690818152602001505081846005016000506000866004016000508054905063ffffffff168152602001908152602001600020600050600082015181600001600050556020820151816001016000505590505083600301600481819054906101000a900463ffffffff168092919060010191906101000a81548163ffffffff0219169083021790555050600090505b8663ffffffff168163ffffffff161015610888576004840180546001810180835582818380158290116108e25760070160089004816007016008900483600052602060002091820191016108e2919061093a565b6004840154600185015463ffffffff1614156108d8576040805163ffffffff8a16815290517f0f79d2bb89703530438ee4eedcec6dd4f56362f4a08abb7f99d5172ec2f78c1b9181900360200190a15b5050505050505050565b505050600092835260209092206008808304909101910660040285909190916101000a81548163ffffffff0219169083021790555050600101610834565b601f016020900490600052602060002090810190610e1e91905b8082111561094e576000815560010161093a565b5090565b600019870163ffffffff81166000908152600586016020526040812054919450141561097d57610002565b63ffffffff83166000908152600585016020526040812060010154146109a257610002565b63ffffffff83166000908152600585016020908152604080519281902054898452905192839003909101909120146109d957610002565b63ffffffff838116600090815260058601602090815260409182902060019081018a9055600388018054680100000000000000008082049096169092019094026bffffffff00000000000000001991909116179092558051878152905133600160a060020a0316927fb3e034c1f43bc4d45ac2e95fc65eefeaa5bf9cf5fb8d8e882768d02c0c76428d928290030190a28360030160049054906101000a900463ffffffff1663ffffffff168460030160089054906101000a900463ffffffff1663ffffffff1614156108d8575060005b600184015463ffffffff9081169082161015610af75760018481015463ffffffff83811660009081526005880160205260409020909201549116908115610002570690910190600101610aa9565b600184015463ffffffff168281156100025760038601805463ffffffff19169290910660010191909117908190556040805163ffffffff8b8116825292909216602083015280517f031e7c12801a6c644cd51b871f1673da5679eb7e4b71bd0d7b64349418a714a09281900390910190a15050505050505050565b820191906000526020600020905b815481529060010190602001808311610b8057829003601f168201915b505050506001838101546002858101805460408051602096831615610100026000190190921693909304601f8101869004860282018601909352828152959e5063ffffffff929092169c5090925090830182828015610c3d5780601f10610c1257610100808354040283529160200191610c3d565b820191906000526020600020905b815481529060010190602001808311610c2057829003601f168201915b5050505060048301546003840154929950975050640100000000810463ffffffff90811696506801000000000000000082048116955016925060008314610d1657600481018054600254600160a060020a031691631d0cce4c91600019870163ffffffff16908110156100025790600052602060002090600891828204019190066004029054906101000a900463ffffffff166040518260e060020a028152600401808263ffffffff168152602001915050602060405180830381600087803b156100025760325a03f115610002575050604051519250505b50919395975091939597565b84815263ffffffff841660208201526040810183905260038054600181018083558281838015829011610d6e57600602816006028360005260206000209182019101610d6e9190610dec565b5050509190906000526020600020906006020160008390919091506000820151816000016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610eb257805160ff19168380011785555b50610ee292915061093a565b50506006015b8082111561094e57600060008201600050805460018160011615610100020316600290046000825580601f1061092057505b506001828101805463ffffffff191690556002838101805460008255909281161561010002600019011604601f819010610e9457505b506003820180546bffffffffffffffffffffffff1916905560048201805460008083559182526020909120610de69160086007919091010481019061093a565b601f016020900490600052602060002090810190610e54919061093a565b82800160010185558215610dda579182015b82811115610dda578251826000505591602001919060010190610ec4565b505060208201518160010160006101000a81548163ffffffff021916908302179055506040820151816002016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610f6257805160ff19168380011785555b50610f9292915061093a565b82800160010185558215610f56579182015b82811115610f56578251826000505591602001919060010190610f74565b50506060820151600382018054608085015160a086015168010000000000000000026401000000009190910263ffffffff199290921690931767ffffffff000000001916176bffffffff0000000000000000191691909117905560c0820151805160048301805482825560008281526020908190209294600860079390930192909204830193929101821561106a5791602002820160005b8382111561108d57835183826101000a81548163ffffffff02191690830217905550926020019260040160208160030104928301926001030261102a565b505b506110bd9291505b8082111561094e57805463ffffffff19168155600101611072565b80156110685782816101000a81549063ffffffff021916905560040160208160030104928301926001030261108d565b5050600354604080519182526020820187905280517f2d3041463394d5524c09cd5c99da6cb681f797a7beb92a59ac853ab1889a04ee9550918290030192509050a1505050505056', 
     gas: 4700000
   }, function (e, contract){
    console.log(e, contract);
    if (typeof contract.address !== 'undefined') {
         console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
    }
 });
miner.start(1); admin.sleepBlocks(1); miner.stop();

// 初始化合约地址
personal.unlockAccount(eth.accounts[0], "test123456");
onechancecoin.initOneChance.sendTransaction(onechance.address, {from: eth.accounts[0], gas: 10000000});
miner.start(1); admin.sleepBlocks(1); miner.stop();

// 打印合约初始化结果
console.log("onechancecoin -", "addresscompress address -", onechancecoin.addressCompress.call());
console.log("OneChance -", "addresscompress address -", onechance.addressCompress.call());
console.log("onechancecoin -", "oneChance address -", onechancecoin.oneChance.call());
console.log("onechance -", "oneChanceCoin address -", onechance.oneChanceCoin.call());
